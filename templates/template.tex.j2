\documentclass[12pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{fontawesome5}
\usepackage[french]{babel}
\usepackage{geometry}
\usepackage{graphicx}
\usepackage{array}
\usepackage{titlesec}
\usepackage{longtable}
\usepackage{hyperref}
\geometry{margin=2.5cm}
\usepackage{fancyhdr}
\usepackage{subcaption}
\usepackage{enumitem}
\usepackage{colortbl}  % Pour rowcolors dans les tableaux
\usepackage[table]{xcolor}  % Couleurs avancées pour tableaux

% Support pour les images SVG
\usepackage{svg}
\svgsetup{inkscapelatex=false}

% Packages pour les sections écologie
\usepackage{tcolorbox}
\tcbuselibrary{skins,breakable}
\usepackage{tikz}
\usetikzlibrary{shapes.geometric, positioning, shadows.blur, calc, arrows.meta}
\usepackage{xcolor}

% Couleurs écologiques
\definecolor{ecoVert}{HTML}{27AE60}
\definecolor{ecoVertFonce}{HTML}{1E8449}
\definecolor{ecoVertClair}{HTML}{A9DFBF}
\definecolor{ecoBleu}{HTML}{3498DB}
\definecolor{ecoMarron}{HTML}{795548}
\definecolor{ecoFond}{HTML}{F0FDF4}
\definecolor{traitBleu}{HTML}{2C3E50}
\definecolor{gray}{HTML}{5D6D7E}

% Style tcolorbox pour les sous-sections méthodologie (adaptatif)
\newtcolorbox{methodebox}[2][]{
    enhanced,
    colback=white,
    colframe=#2,
    fonttitle=\bfseries,
    coltitle=white,
    colbacktitle=#2,
    rounded corners,
    boxrule=1.2pt,
    left=6pt, right=6pt, top=6pt, bottom=6pt,
    #1
}

\setlength{\parindent}{0pt}
\setlength{\parskip}{0.5em}

\titleformat{\section}{\large\bfseries}{\thesection}{1em}{}
\titleformat{\subsection}{\normalsize\bfseries}{\thesubsection}{1em}{}
% Ajustement de la hauteur d'en-tête pour éviter les avertissements
\setlength{\headheight}{80pt}
\addtolength{\topmargin}{-35pt}

\pagestyle{fancy}
\fancyhf{}
\fancyhead[C]{
  \hspace*{-1in}\hspace*{-\oddsidemargin}
  \includegraphics[width=\paperwidth, height=3cm]{../images/entete.png}
}

% --- NUMÉROTATION DES PAGES ---
\fancyfoot[C]{\thepage}
\renewcommand{\headrulewidth}{0pt}
\renewcommand{\footrulewidth}{0.4pt}

\begin{document}

\thispagestyle{empty}

% PAGE DE GARDE
\begin{titlepage}
    % Titre centré
    \begin{center}
        {\Huge \textbf{MÉMOIRE TECHNIQUE}} \\
        \vspace{0.25cm}
        {\Large \textbf{ {{Intitule_operation}} }} \\
        \vspace{0.15cm}
        {\large \textbf{LOT : {{ Lot_Intitule }} }} \\
    \end{center}
    
    \vspace{0.15cm}
    
    % Maître d'ouvrage et adresse chantier
    \begin{center}
    {\small \textbf{Maître d'ouvrage :} {{ Maitre_ouvrage_nom }} \\
    \textbf{Adresse du chantier :} {{ Adresse_chantier }}}
    \end{center}
    
    {% if image_garde %}
    \vspace{0.15cm}
    \begin{center}
    \begin{tcolorbox}[
        enhanced,
        colback=white,
        colframe=ecoBleu!50,
        boxrule=1pt,
        arc=3pt,
        width=0.9\textwidth,
        halign=center
    ]
    {% if '.svg' in image_garde %}
    \includesvg[width=0.85\textwidth, height=7cm, keepaspectratio]{ {{image_garde}} }
    {% else %}
    \includegraphics[width=0.85\textwidth, height=7cm, keepaspectratio]{ {{image_garde}} }
    {% endif %}
    \end{tcolorbox}
    \end{center}
    {% endif %}
    
    \vspace{0.15cm}
    
    % En-tête avec logo bois et logos de certifications
    \begin{center}
    \includegraphics[height=3.5cm]{../images/logo_boisTechniques.png}
    
    \vspace{0.15cm}
    
    % Une ligne de 8 logos
    \includegraphics[height=1.1cm]{../images/logo_pefc2 (1).png}\hspace{0.5cm}
    \includegraphics[height=1.1cm]{../images/logo_fsc.png}\hspace{0.5cm}
    \includegraphics[height=1.1cm]{../images/logo_rge (1).png}\hspace{0.5cm}
    \includegraphics[height=1.1cm]{../images/logo_qualibat (1).png}\hspace{0.5cm}
    \includegraphics[height=1.1cm]{../images/logo_garantie-decenale2 (1).png}\hspace{0.5cm}
    \includegraphics[height=1.1cm]{../images/logo_ffb_adherent (1).png}\hspace{0.5cm}
    \includegraphics[height=1.1cm]{../images/logo_artisan.png}
    \includegraphics[height=1.1cm]{../images/logo_region_alsace.png}
    \end{center}
    
    \vspace{0.05cm}
    \noindent\rule{\linewidth}{1.5pt}
    
    \vspace{0.05cm}
    
    % Blocs d'informations séparés sans bordures - 3 blocs compacts
    \begin{center}
    \begin{minipage}[c]{5.2cm}
    \centering
    {\fontsize{7.5}{8.5}\selectfont\textbf{ADRESSE :}} \\
    {\fontsize{7}{8}\selectfont ZI - 19 Rue de l'Industrie} \\
    {\fontsize{7}{8}\selectfont 68360 SOULTZ}
    \end{minipage}%
    \hspace{0.08cm}%
    \begin{minipage}[c]{5.2cm}
    \centering
    {\fontsize{7}{8}\selectfont\textbf{TELEPHONE :}} \\
    {\fontsize{7}{8}\selectfont 03 89 53 36 58} \\
    {\fontsize{7}{8}\selectfont\textbf{COURRIEL :}} \\
    {\fontsize{7}{8}\selectfont contact@bois-techniques.fr}
    \end{minipage}%
    \hspace{0.08cm}%
    \begin{minipage}[c]{5.2cm}
    \centering
    {\fontsize{7}{8}\selectfont\textbf{SITE INTERNET :}} \\
    {\fontsize{7}{8}\selectfont www.bois-techniques.fr}
    \end{minipage}
    \end{center}
    
    \vspace{0.05cm}
    \noindent\rule{\linewidth}{0.5pt}
    \vspace{0.05cm}
    
    {\fontsize{6.5}{7.5}\selectfont SAS au capital de 100 000 euros – TVA intracommunautaire FR 50 893 822 841 – Siret n°893 822 841 00027 – APE 4391A – IBAN FR76 3000 4026 7700 0102 3762 986}
    
\end{titlepage}

\tableofcontents
\newpage

% PRÉAMBULE
\section*{PRÉAMBULE}
\noindent
L'entreprise Bois \& Techniques, située à Soultz (68360), est spécialisée dans la
conception, la fabrication et la pose de charpentes bois, ouvrages structurels. Forte d'une expérience significative dans le domaine de la construction
bois, elle intervient sur des projets variés : logements individuels, bâtiments collectifs,
équipements publics ou tertiaires. Restauration de structure bois type colombage et solivage.
\vspace{0.3cm}

L'entreprise dispose de ses propres équipes de charpentiers, encadrées par
un chef de chantier expérimenté. Les ouvrages sont fabriqués dans un atelier équipé
et adaptés aux exigences de la construction bois moderne.
\vspace{0.3cm}

Réalisé par le bureau d’étude interne de la société Bois \& Techniques, le présent mémoire
technique a pour objectif de vous exposer les solutions techniques et l'organisation de
chantier envisagée, afin de mener votre projet dans les meilleures conditions.
En espérant que ce mémoire technique illustrera l'intérêt que nous portons à votre projet.

% SECTIONS DYNAMIQUES ISSUES DU CSV
{% for section in data %}
{% set titre_lower = section.titre | lower %}
{% if 'contexte du projet' in titre_lower %}
% Section spéciale pour le contexte du projet (affichage stylisé adaptatif)
\section{ {{ section.titre }} }

{% set contexte_ss = {} %}
{% set contexte_colors = {} %}
{% for ss in section.sous_sections %}
{% set ss_nom_lower = ss.nom | lower %}
{% if 'contexte' in ss_nom_lower and 'environnement' not in ss_nom_lower and 'contrainte' not in ss_nom_lower %}
{% set _ = contexte_ss.update({'date': ss.contenu}) %}
{% set _ = contexte_colors.update({'date': ss.couleur | default('ecoBleu')}) %}
{% elif 'environnement' in ss_nom_lower %}
{% set _ = contexte_ss.update({'environnement': ss.contenu}) %}
{% set _ = contexte_colors.update({'environnement': ss.couleur | default('ecoBleu')}) %}
{% elif 'acces' in ss_nom_lower or 'accès' in ss_nom_lower %}
{% set _ = contexte_ss.update({'acces': ss.contenu}) %}
{% set _ = contexte_colors.update({'acces': ss.couleur | default('ecoBleu')}) %}
{% elif 'levage' in ss_nom_lower %}
{% set _ = contexte_ss.update({'levage': ss.contenu}) %}
{% set _ = contexte_colors.update({'levage': ss.couleur | default('ecoBleu')}) %}
{% elif 'contrainte' in ss_nom_lower %}
{% set _ = contexte_ss.update({'contraintes': ss.contenu}) %}
{% set _ = contexte_colors.update({'contraintes': ss.couleur | default('red!70!black')}) %}
{% endif %}
{% endfor %}
{% if contexte_ss.contraintes %}
\begin{tcolorbox}[
    enhanced,
    colback=white,
    colframe={{ contexte_colors.contraintes | default('red!70!black') }},
    fonttitle=\bfseries,
    coltitle=white,
    title={\faIcon{exclamation-triangle}\hspace{0.3em}Contraintes du chantier},
    colbacktitle={{ contexte_colors.contraintes | default('red!70!black') }},
    rounded corners,
    boxrule=1.5pt,
    left=10pt, right=10pt, top=6pt, bottom=6pt
]
\small
{{ contexte_ss.contraintes }}
\end{tcolorbox}
\vspace{0.4cm}
{% endif %}

{% if contexte_ss.levage %}
\begin{tcolorbox}[
    enhanced,
    colback=white,
    colframe={{ contexte_colors.levage | default('ecoBleu') }},
    fonttitle=\bfseries,
    coltitle=white,
    title={\faIcon{truck-loading}\hspace{0.3em}Levage},
    colbacktitle={{ contexte_colors.levage | default('ecoBleu') }},
    rounded corners,
    boxrule=1.5pt,
    left=8pt, right=8pt, top=6pt, bottom=6pt
]
\small
{{ contexte_ss.levage }}
\end{tcolorbox}
\vspace{0.4cm}
{% endif %}

{% if contexte_ss.environnement %}
\begin{tcolorbox}[
    enhanced,
    colback=white,
    colframe={{ contexte_colors.environnement | default('ecoBleu') }},
    fonttitle=\bfseries,
    coltitle=white,
    title={\faIcon{map-marker-alt}\hspace{0.3em}Localisation},
    colbacktitle={{ contexte_colors.environnement | default('ecoBleu') }},
    rounded corners,
    boxrule=1.5pt,
    left=8pt, right=8pt, top=6pt, bottom=6pt
]
\small
{{ contexte_ss.environnement }}
\end{tcolorbox}
\vspace{0.4cm}
{% endif %}

% Plan de masse / Vue aérienne
{% if plan_emplacement %}
\begin{tcolorbox}[
    enhanced,
    colback=white,
    colframe={{ contexte_colors.get('environnement', 'ecoBleu') | default('ecoBleu') }},
    fonttitle=\bfseries\large,
    coltitle=white,
    title={\faIcon{map-marked-alt}\hspace{0.3em}Plan de masse / Vue aérienne},
    colbacktitle={{ contexte_colors.get('environnement', 'ecoBleu') | default('ecoBleu') }},
    rounded corners,
    boxrule=2pt,
    left=12pt, right=12pt, top=8pt, bottom=8pt
]
\centering
{% if '.svg' in plan_emplacement %}
\includegraphics[width=0.90\textwidth, height=10cm, keepaspectratio]{ {{plan_emplacement}} }
{% else %}
\includegraphics[width=0.90\textwidth, height=10cm, keepaspectratio]{ {{plan_emplacement}} }
{% endif %}
\end{tcolorbox}
\vspace{0.4cm}
{% endif %}

{% if contexte_ss.date %}
\begin{tcolorbox}[
    enhanced,
    colback=white,
    colframe={{ contexte_colors.date | default('ecoBleu') }},
    fonttitle=\bfseries\large,
    coltitle=white,
    title={\faIcon{calendar-check}\hspace{0.3em}Visite de site},
    colbacktitle={{ contexte_colors.date | default('ecoBleu') }},
    rounded corners,
    boxrule=2pt,
    left=12pt, right=12pt, top=8pt, bottom=8pt
]
{{ contexte_ss.date }}
\end{tcolorbox}
\vspace{0.4cm}
{% else %}
% Affichage par défaut com pointillés
\begin{tcolorbox}[
    enhanced,
    colback=ecoFond,
    colframe=ecoBleu,
    fonttitle=\bfseries\large,
    coltitle=white,
    title={\faIcon{calendar-check}\hspace{0.3em}Visite de site},
    colbacktitle=ecoBleu,
    rounded corners,
    boxrule=2pt,
    left=12pt, right=12pt, top=8pt, bottom=8pt
]
Nous sommes rendus sur les lieux le \dotfill

\vspace{0.3cm}
{% if Adresse_chantier %}
Adresse : {{ Adresse_chantier }}
{% else %}
Adresse : \dotfill
{% endif %}
\end{tcolorbox}
\vspace{0.4cm}
{% endif %}

{% if attestation_visite %}
\begin{tcolorbox}[
    enhanced,
    colback=white,
    colframe=ecoBleu,
    fonttitle=\bfseries\large,
    coltitle=white,
    title={\faIcon{file-signature}\hspace{0.3em}Attestation de visite},
    colbacktitle=ecoBleu,
    rounded corners,
    boxrule=2pt,
    left=8pt, right=8pt, top=6pt, bottom=6pt
]
{% if '.svg' in attestation_visite %}
\includegraphics[width=0.95\textwidth, height=20cm, keepaspectratio]{ {{attestation_visite}} }
{% else %}
\includegraphics[width=0.95\textwidth, height=20cm, keepaspectratio]{ {{attestation_visite}} }
{% endif %}
\end{tcolorbox}
\vspace{0.4cm}
{% endif %}

{% if contexte_ss.acces %}
\begin{tcolorbox}[
    enhanced,
    colback=white,
    colframe=traitBleu,
    fonttitle=\bfseries,
    coltitle=white,
    title={\faIcon{parking}\hspace{0.3em}Accès Chantier et Stationnement},
    colbacktitle=traitBleu,
    rounded corners,
    boxrule=1.5pt,
    left=10pt, right=10pt, top=6pt, bottom=6pt
]
{{ contexte_ss.acces }}
\end{tcolorbox}
\vspace{0.4cm}
\vspace{0.4cm}
{% endif %}

{% elif 'situation administrative' in titre_lower %}
% Section spéciale pour la situation administrative (affichage stylisé)
\newpage
\section{ {{ section.titre }} }
\input{../templates/situation_administrative_generated.tex}
{% elif 'moyens materiel' in titre_lower or 'moyens matériel' in titre_lower %}
% Section spéciale pour les moyens matériels (affichage stylisé)
\newpage
\section{ {{ section.titre }} }
\vspace{-0.3cm}
\input{../templates/moyens_materiel_generated.tex}
{% elif 'chantiers references' in titre_lower or 'chantiers références' in titre_lower %}
% Section spéciale pour les chantiers de référence (affichage stylisé)
\newpage
\section{ {{ section.titre }} }

\begin{tcolorbox}[
    enhanced,
    colback=white,
    colframe=ecoBleu,
    fonttitle=\bfseries\large,
    coltitle=white,
    title={\faIcon{building}\hspace{0.3em}Nos Références},
    colbacktitle=ecoBleu,
    rounded corners,
    boxrule=2pt,
    left=10pt, right=10pt, top=10pt, bottom=10pt
]

\small
L'entreprise \textbf{Bois \& Techniques} a réalisé de nombreux chantiers similaires. Voici quelques références en rapport avec cette opération :

\vspace{0.3cm}

{% for ss in section.sous_sections %}
{{ ss.contenu | markdown_to_latex }}
{% endfor %}

\end{tcolorbox}

{% else %}
\newpage
\section{ {{ section.titre }} }

    {% for ss in section.sous_sections %}
    {% set nom_lower = ss.nom | lower %}
    {% if 'demarche hqe' in nom_lower %}
    % Inclusion du fichier spécial pour la démarche HQE
    \input{../templates/demarche_hqe_generated.tex}
    {% elif 'demarche environnementale' in nom_lower and 'atelier' in nom_lower %}
    % Inclusion du fichier spécial pour la démarche environnementale atelier
    \input{../templates/demarche_env_atelier_generated.tex}
    {% elif 'demarche environnementale' in nom_lower and 'chantier' in nom_lower %}
    % Inclusion du fichier spécial pour la démarche environnementale chantiers
    \input{../templates/demarche_env_chantiers_generated.tex}
    {% elif 'methodologie de traitement' in nom_lower %}
    % Inclusion du fichier spécial pour méthodologie de traitement
    \input{../templates/methodologie_traitement_generated.tex}
    {% elif 'matiere premiere' in nom_lower and 'qualite' in nom_lower %}
    % Inclusion du fichier spécial pour matière première de qualité certifiée
    \subsection{ {{ ss.nom }} }
    \input{../templates/matiere_premiere_generated.tex}
    {% elif 'securite et sante sur les chantiers' in nom_lower %}
    % Inclusion du fichier spécial pour sécurité et santé
    \subsection{ {{ ss.nom }} }
    \input{../templates/securite_sante_generated.tex}
    {% elif 'organigramme' in nom_lower %}
    % Inclusion du PDF de l'organigramme
    \subsection{ {{ ss.nom }} }
    {% if ss.image %}
    \begin{center}
    \includegraphics[width=0.85\textwidth, height=0.7\textheight, keepaspectratio]{ {{ ss.image }} }
    \end{center}
    {% endif %}
    {% if ss.contenu %}
    {{ ss.contenu | replace('\n', ' \\\\\n') }}
    {% endif %}
    {% elif 'deroulement des travaux' in nom_lower %}
    % Style spécial pour déroulement des travaux
    \begin{methodebox}[title={\faIcon{clipboard-list}\hspace{0.3em}{{ ss.nom }}}]{{ ss.couleur }}
    {% if ss.contenu %}
    {{ ss.contenu | replace('\n', ' \\\\\n') | markdown_to_latex }}
    {% endif %}
    \end{methodebox}
    {% elif 'conception' in nom_lower and 'precision' not in nom_lower %}
    % Style spécial pour conception
    \begin{methodebox}[title={\faIcon{drafting-compass}\hspace{0.3em}{{ ss.nom }}}]{{ ss.couleur }}
    {% if ss.contenu %}
    {{ ss.contenu | replace('\n', ' \\\\\n') | markdown_to_latex }}
    {% endif %}
    \end{methodebox}
    {% elif 'fabrication' in nom_lower or 'taille' in nom_lower %}
    % Style spécial pour fabrication/taille
    \begin{methodebox}[title={\faIcon{hammer}\hspace{0.3em}{{ ss.nom }}}]{{ ss.couleur }}
    {% if ss.contenu %}
    {% if '\\begin{itemize}' in ss.contenu %}
    {{ ss.contenu | markdown_to_latex }}
    {% else %}
    {{ ss.contenu | replace('\n', ' \\\\\n') | markdown_to_latex }}
    {% endif %}
    {% endif %}
    \end{methodebox}
    {% elif 'transport' in nom_lower and 'levage' in nom_lower %}
    % Style spécial pour transport et levage
    % Contenu Transport et Levage
    \begin{methodebox}[title={\faIcon{truck-loading}\hspace{0.3em}{{ ss.nom }}}]{{ ss.couleur }}
    {% if ss.contenu %}
    {% if '\\begin{itemize}' in ss.contenu %}
    {{ ss.contenu | markdown_to_latex }}
    {% else %}
    {{ ss.contenu | replace('\n', ' \\\\\n') | markdown_to_latex }}
    {% endif %}
    {% endif %}
    \end{methodebox}
    \vspace{0.3cm}
    {% if image_grue %}
    % Image de la grue, centrée
    \begin{center}
    \begin{tcolorbox}[
        enhanced,
        colback=white,
        colframe=ecoBleu,
        fonttitle=\bfseries\large,
        coltitle=white,
        title={\faIcon{truck-monster}\hspace{0.3em}Moyens de levage},
        colbacktitle=ecoBleu,
        rounded corners,
        boxrule=2pt,
        width=\textwidth,
        halign=center
    ]
    {% if '.svg' in image_grue %}
    \includesvg[width=0.8\textwidth, height=8cm, keepaspectratio]{ {{image_grue}} }
    {% else %}
    \includegraphics[width=0.8\textwidth, height=8cm, keepaspectratio]{ {{image_grue}} }
    {% endif %}
    \end{tcolorbox}
    \end{center}
    {% endif %}
    {% elif nom_lower == 'chantier' %}
    % Style spécial pour chantier
    \begin{methodebox}[title={\faIcon{hard-hat}\hspace{0.3em}{{ ss.nom }}}]{{ ss.couleur }}
    {% if ss.contenu %}
    {% if '\\begin{itemize}' in ss.contenu %}
    {{ ss.contenu | markdown_to_latex }}
    {% else %}
    {{ ss.contenu | replace('\n', ' \\\\\n') | markdown_to_latex }}
    {% endif %}
    {% endif %}
    \end{methodebox}
    {% elif 'protection de l' in nom_lower or 'protection/nettoyage' in nom_lower %}
    % Style spécial pour protection
    \begin{methodebox}[title={\faIcon{shield-alt}\hspace{0.3em}{{ ss.nom }}}]{{ ss.couleur }}
    {% if ss.contenu %}
    {% if '\\begin{itemize}' in ss.contenu %}
    {{ ss.contenu }}
    {% else %}
    {{ ss.contenu | replace('\n', ' \\\\\n') }}
    {% endif %}
    {% endif %}
    \end{methodebox}
    {% elif 'organisation' in nom_lower and ('hygiene' in nom_lower or 'hygiène' in nom_lower or 'securite' in nom_lower) %}
    % Style spécial pour hygiène et sécurité
    \begin{methodebox}[title={\faIcon{first-aid}\hspace{0.3em}{{ ss.nom }}}]{{ ss.couleur }}
    {% if ss.contenu %}
    {% if '\\begin{itemize}' in ss.contenu %}
    {{ ss.contenu }}
    {% else %}
    {{ ss.contenu | replace('\n', ' \\\\\n') }}
    {% endif %}
    {% endif %}
    \end{methodebox}
    {% elif 'mode operatoire' in nom_lower or 'mode opératoire' in nom_lower %}
    % Style spécial pour mode opératoire particulier
    \begin{methodebox}[title={\faIcon{cogs}\hspace{0.3em}{{ ss.nom }}}]{{ ss.couleur }}
    {% if ss.contenu %}
    {% if '\\begin{itemize}' in ss.contenu %}
    {{ ss.contenu }}
    {% else %}
    {{ ss.contenu | replace('\n', ' \\\\\n') }}
    {% endif %}
    {% endif %}
    \end{methodebox}
    {% elif 'fixation' in nom_lower and 'assemblage' in nom_lower %}
    % Tableau stylé pour Fixation et assemblage
    \begin{tcolorbox}[
        enhanced,
        colback=white,
        colframe={{ ss.couleur }},
        fonttitle=\bfseries\large,
        coltitle=white,
        title={\faIcon{cogs}\hspace{0.3em}{{ ss.nom }}},
        colbacktitle={{ ss.couleur }},
        rounded corners,
        boxrule=2pt,
        left=3pt, right=3pt, top=5pt, bottom=5pt
    ]
    {% if ss.contenu %}
    \renewcommand{\arraystretch}{1.3}
    \small
    \rowcolors{2}{ecoFond}{white}
    {{ ss.contenu | replace('\\begin{tabular}{|p{5cm}|p{4cm}|p{3cm}|p{2cm}|}', '\\begin{tabular}{p{4.5cm}p{4.5cm}p{3cm}p{2cm}}') | replace('\\hline', '') | replace('\\textbf{Nature', '\\rowcolor{ecoMarron!20}\\textbf{Nature') }}
    {% endif %}
    \end{tcolorbox}
    {% elif 'traitement' in nom_lower and ('preventif' in nom_lower or 'préventif' in nom_lower) %}
    % Tableau stylisé pour Traitement Préventif
    \begin{tcolorbox}[
        enhanced,
        colback=white,
        colframe={{ ss.couleur }},
        fonttitle=\bfseries\large,
        coltitle=white,
        title={\faIcon{shield-alt}\hspace{0.3em}{{ ss.nom }}},
        colbacktitle={{ ss.couleur }},
        rounded corners,
        boxrule=2pt,
        left=3pt, right=3pt, top=5pt, bottom=5pt
    ]
    {% if ss.contenu %}
    \renewcommand{\arraystretch}{1.3}
    \small
    \rowcolors{2}{ecoFond}{white}
    {{ ss.contenu | replace('\\begin{tabular}{|p{4cm}|p{6cm}|p{2.5cm}|p{1.5cm}|}', '\\begin{tabular}{p{4cm}p{6cm}p{2.5cm}p{1.5cm}}') | replace('\\hline', '') | replace('\\textbf{Nature', '\\rowcolor{ecoVert!20}\\textbf{Nature') }}
    {% endif %}
    \end{tcolorbox}
    {% elif 'traitement' in nom_lower and ('curatif' in nom_lower) %}
    % Tableau stylisé pour Traitement Curatif
    \begin{tcolorbox}[
        enhanced,
        colback=white,
        colframe={{ ss.couleur }},
        fonttitle=\bfseries\large,
        coltitle=white,
        title={\faIcon{hammer}\hspace{0.3em}{{ ss.nom }}},
        colbacktitle={{ ss.couleur }},
        rounded corners,
        boxrule=2pt,
        left=3pt, right=3pt, top=5pt, bottom=5pt
    ]
    {% if ss.contenu %}
    \renewcommand{\arraystretch}{1.3}
    \small
    \rowcolors{2}{ecoFond}{white}
    {{ ss.contenu | replace('\\begin{tabular}{|p{4cm}|p{6cm}|p{2.5cm}|p{1.5cm}|}', '\\begin{tabular}{p{4cm}p{6cm}p{2.5cm}p{1.5cm}}') | replace('\\hline', '') | replace('\\textbf{Nature', '\\rowcolor{ecoVert!20}\\textbf{Nature') }}
    {% endif %}
    \end{tcolorbox}
    {% elif 'produit utilisé' in nom_lower %}
    % Bloco Produit utilisé sem subsection numerada
    {% if '\\begin{tcolorbox}' in ss.contenu %}
    {{ ss.contenu }}
    {% else %}
    {{ ss.contenu | replace('\n', ' \\\\\n') }}
    {% endif %}
    {% elif 'produits' in nom_lower and 'fiches' in nom_lower %}
    % Subsection 2.2 - Produits proposés
    \subsection{ {{ ss.nom | upper }} }
    {% if ss.contenu %}
    {{ ss.contenu | replace('\n', ' \\\\\n') }}
    {% endif %}
    {% else %}
    \subsection{ {{ ss.nom }} }
    {% if '\\begin{tabular}' in ss.contenu or '\\begin{itemize}' in ss.contenu or '\\begin{center}' in ss.contenu or '\\begin{tcolorbox}' in ss.contenu %}
    {{ ss.contenu }}
    {% else %}
    {{ ss.contenu | replace('\n', ' \\\\\n') }}
    {% endif %}

    {% if ss.image %}
    \begin{center}
        \includegraphics[width=1\textwidth]{ {{ ss.image }} }
    \end{center}
    {% endif %}
    {% endif %}

    {% endfor %}
{% endif %}

{% endfor %}

\newpage
% ANNEXES
\section{ANNEXES}

\end{document}
